#CODEBOOK FOR FIXING CODES haha

This codebook can be run after running the R Script "Import of voter turnout data.R"
NB You need to download the IDEA data first and set working directory  

#VoterData preparation

Import and wrangling
```{r}
library(readxl)
VoterDat<- read_excel("Voter turnout data/idea_export_40_5edfe09b20bc6.xls")


#Remove all observations that are not from 2014 and 2019 as well as unecessesary variables (columns)
VoterDat1419 <- VoterDat %>% 
  filter(Year > 2013) %>% 
  select(Country, Year, `Voter Turnout`, `Total vote`, Population)
```


Transforming three columns to numeric
```{r} 

VoterDat1419$Population <- as.numeric(gsub(",","",VoterDat1419$Population))
VoterDat1419$'Total vote' <- as.numeric(gsub(",","",VoterDat1419$'Total vote'))
VoterDat1419$`Voter Turnout` <- as.numeric(gsub("%", "", VoterDat1419$`Voter Turnout`))

```

#Gtrends data preparation and merging

Spread the three keywords for each IOT-object (created in R Script "Import of voter turnout)
```{r}
AT14IOT<- AT14IOT %>% 
  spread(key = keyword, value = hits)
AT19IOT <- AT19IOT %>% 
  spread(key = keyword, value = hits)

CZ14IOT <- CZ14IOT %>% 
  spread(key = keyword, value = hits)
CZ19IOT <- CZ19IOT %>% 
  spread(key = keyword, value = hits)

DE14IOT <- DE14IOT %>% 
  spread(key = keyword, value = hits)
DE19IOT <- DE19IOT %>% 
  spread(key = keyword, value = hits)

DK14IOT <- DK14IOT %>% 
  spread(key = keyword, value = hits)
DK19IOT <- DK19IOT %>% 
  spread(key = keyword, value = hits)

EE14IOT <- EE14IOT %>% 
  spread(key = keyword, value = hits)
EE19IOT <- EE19IOT %>% 
  spread(key = keyword, value = hits)

ES14IOT <- ES14IOT %>% 
  spread(key = keyword, value = hits)
ES19IOT <- ES19IOT %>% 
  spread(key = keyword, value = hits)

FI14IOT <- FI14IOT %>% 
  spread(key = keyword, value = hits)
FI19IOT <- FI19IOT %>% 
  spread(key = keyword, value = hits)

FR14IOT <- FR14IOT %>% 
  spread(key = keyword, value = hits)
FR19IOT <- FR19IOT %>% 
  spread(key = keyword, value = hits)

GB14IOT <- GB14IOT %>% 
  spread(key = keyword, value = hits)
GB19IOT <- GB19IOT %>% 
  spread(key = keyword, value = hits)

HR14IOT <- HR14IOT %>% 
  spread(key = keyword, value = hits)
HR19IOT <- HR19IOT %>% 
  spread(key = keyword, value = hits)

HU14IOT <- HU14IOT %>% 
  spread(key = keyword, value = hits)
HU19IOT <- HU19IOT %>% 
  spread(key = keyword, value = hits)

IE14IOT <- IE14IOT %>% 
  spread(key = keyword, value = hits)
IE19IOT <- IE19IOT %>% 
  spread(key = keyword, value = hits)

IT14IOT <- IT14IOT %>% 
  spread(key = keyword, value = hits)
IT19IOT <- IT19IOT %>% 
  spread(key = keyword, value = hits)

LU14IOT <- LU14IOT %>% 
  spread(key = keyword, value = hits)
LU19IOT <- LU19IOT %>% 
  spread(key = keyword, value = hits)

LV14IOT <- LV14IOT %>% 
  spread(key = keyword, value = hits)
LV19IOT <- LV19IOT %>% 
  spread(key = keyword, value = hits)

NL14IOT <- NL14IOT %>% 
  spread(key = keyword, value = hits)
NL19IOT <- NL19IOT %>% 
  spread(key = keyword, value = hits)

PL14IOT <- PL14IOT %>% 
  spread(key = keyword, value = hits)
PL19IOT <- PL19IOT %>% 
  spread(key = keyword, value = hits)

PT14IOT <- PT14IOT %>% 
  spread(key = keyword, value = hits)
PT19IOT <- PT19IOT %>% 
  spread(key = keyword, value = hits)

RO14IOT <- RO14IOT %>% 
  spread(key = keyword, value = hits)
RO19IOT <- RO19IOT %>% 
  spread(key = keyword, value = hits)

SE14IOT <- SE14IOT %>% 
  spread(key = keyword, value = hits)
SE19IOT <- SE19IOT %>% 
  spread(key = keyword, value = hits)

SI14IOT <- SI14IOT %>% 
  spread(key = keyword, value = hits)
SI19IOT <- SI19IOT %>% 
  spread(key = keyword, value = hits)

SK14IOT <- SK14IOT %>% 
  spread(key = keyword, value = hits)
SK19IOT <- SK19IOT %>% 
  spread(key = keyword, value = hits)

```

For consistency all unique keywords are renamed each IOT-object. 
This makes it possible to meaningfully combine the IOT-objects afterwards  

The new keyword names are as follows:
[1] "EU" #the european union 
[2] "Elec" #european parliament election
[3] "EP" #the european parliament

```{r}
AT14IOT<- AT14IOT %>% 
  dplyr::rename(EU = 'die europäische union', Elec = europawahl, EP = 'europäisches parlament')
AT19IOT <- AT19IOT %>% 
 dplyr::rename(EU = 'die europäische union', Elec = europawahl, EP = 'europäisches parlament')

CZ14IOT <- CZ14IOT %>% 
 dplyr::rename(EU = 'evropská unie', Elec = 'volby do evropského parlamentu', EP = 'evropský parlament')
CZ19IOT <- CZ19IOT %>% 
 dplyr::rename(EU = 'evropská unie', Elec = 'volby do evropského parlamentu', EP = 'evropský parlament')

DE14IOT <- DE14IOT %>% 
 dplyr::rename(EU = 'die europäische union', Elec = europawahl, EP = 'europäisches parlament')
DE19IOT <- DE19IOT %>% 
 dplyr::rename(EU = 'die europäische union', Elec = europawahl, EP = 'europäisches parlament')

DK14IOT <- DK14IOT %>% 
 dplyr::rename(EU = 'den europæiske union', Elec = 'europa-parlamentsvalget', EP = 'europa-parlamentet')
DK19IOT <- DK19IOT %>% 
  dplyr::rename(EU = 'den europæiske union', Elec = 'europa-parlamentsvalget', EP = 'europa-parlamentet')

EE14IOT <- EE14IOT %>% 
 dplyr::rename(EU = 'euroopa liit', Elec = 'euroopa parlamendi valimised', EP = 'euroopa parlament')
EE19IOT <- EE19IOT %>% 
 dplyr::rename(EU = 'euroopa liit', Elec = 'euroopa parlamendi valimised', EP = 'euroopa parlament')

ES14IOT <- ES14IOT %>% 
 dplyr::rename(EU = 'la unión europea', Elec = 'elecciones al parlamento europeo', EP = 'parlamento europeo')
ES19IOT <- ES19IOT %>% 
 dplyr::rename(EU = 'la unión europea', Elec = 'elecciones al parlamento europeo', EP = 'parlamento europeo')

FI14IOT <- FI14IOT %>% 
 dplyr::rename(EU = 'euroopan unioni', Elec = 'europarlamenttivaalit', EP = 'euroopan parlamentti')
FI19IOT <- FI19IOT %>% 
 dplyr::rename(EU = 'euroopan unioni', Elec = 'europarlamenttivaalit', EP = 'euroopan parlamentti')

FR14IOT <- FR14IOT %>% 
 dplyr::rename(EU = 'l’union européenne', Elec = 'élections européennes', EP = 'parlement européen')
FR19IOT <- FR19IOT %>% 
 dplyr::rename(EU = 'l’union européenne', Elec = 'élections européennes', EP = 'parlement européen')

GB14IOT <- GB14IOT %>% 
 dplyr::rename(EU = 'the european union', Elec = 'european parliament election', EP = 'european parliament')
GB19IOT <- GB19IOT %>% 
 dplyr::rename(EU = 'the european union', Elec = 'european parliament election', EP = 'european parliament')

HR14IOT <- HR14IOT %>% 
 dplyr::rename(EU = 'europska unija', Elec = 'izbori za evropski parlament', EP = 'europski parlament')
HR19IOT <- HR19IOT %>% 
 dplyr::rename(EU = 'europska unija', Elec = 'izbori za evropski parlament', EP = 'europski parlament')

HU14IOT <- HU14IOT %>% 
 dplyr::rename(EU = 'az európai unió', Elec = 'európai parlamenti választás', EP = 'európai parlament')
HU19IOT <- HU19IOT %>% 
 dplyr::rename(EU = 'az európai unió', Elec = 'európai parlamenti választás', EP = 'európai parlament')

IE14IOT <- IE14IOT %>% 
 dplyr::rename(EU = 'the european union', Elec = 'european parliament election', EP = 'european parliament')
IE19IOT <- IE19IOT %>% 
 dplyr::rename(EU = 'the european union', Elec = 'european parliament election', EP = 'european parliament')

IT14IOT <- IT14IOT %>% 
 dplyr::rename(EU = 'l’unione europea', Elec = 'elezioni europee', EP = 'parlamento europeo')
IT19IOT <- IT19IOT %>% 
 dplyr::rename(EU = 'l’unione europea', Elec = 'elezioni europee', EP = 'parlamento europeo')

LU14IOT <- LU14IOT %>% 
 dplyr::rename(EU = 'l’union européenne', Elec = 'élections européennes', EP = 'parlement européen')
LU19IOT <- LU19IOT %>% 
 dplyr::rename(EU = 'l’union européenne', Elec = 'élections européennes', EP = 'parlement européen')

LV14IOT <- LV14IOT %>% 
 dplyr::rename(EU = 'eiropas savienība', Elec = 'eiropas parlamenta vēlēšanas', EP = 'eiropas parlaments')
LV19IOT <- LV19IOT %>% 
 dplyr::rename(EU = 'eiropas savienība', Elec = 'eiropas parlamenta vēlēšanas', EP = 'eiropas parlaments')

NL14IOT <- NL14IOT %>% 
 dplyr::rename(EU = 'de europese unie', Elec = 'europese parlementsverkiezingen', EP = 'europees parlement')
NL19IOT <- NL19IOT %>% 
 dplyr::rename(EU = 'de europese unie', Elec = 'europese parlementsverkiezingen', EP = 'europees parlement')

PL14IOT <- PL14IOT %>% 
 dplyr::rename(EU = 'unia europejska', Elec = 'wybory do parlamentu europejskiego', EP = 'parlament europejski')
PL19IOT <- PL19IOT %>% 
 dplyr::rename(EU = 'unia europejska', Elec = 'wybory do parlamentu europejskiego', EP = 'parlament europejski')

PT14IOT <- PT14IOT %>% 
 dplyr::rename(EU = 'a união europeia', Elec = 'eleições parlamentares europeias', EP = 'parlamento europeu')
PT19IOT <- PT19IOT %>% 
 dplyr::rename(EU = 'a união europeia', Elec = 'eleições parlamentares europeias', EP = 'parlamento europeu')
 	
RO14IOT <- RO14IOT %>% 
 dplyr::rename(EU = 'uniunea europeană', Elec = 'alegeri pentru parlamentul european', EP = 'parlamentul european')
RO19IOT <- RO19IOT %>% 
 dplyr::rename(EU = 'uniunea europeană', Elec = 'alegeri pentru parlamentul european', EP = 'parlamentul european')

SE14IOT <- SE14IOT %>% 
 dplyr::rename(EU = 'europeiska unionen', Elec = 'europaparlamentsvalet', EP = 'europaparlamentet')
SE19IOT <- SE19IOT %>% 
 dplyr::rename(EU = 'europeiska unionen', Elec = 'europaparlamentsvalet', EP = 'europaparlamentet')

SI14IOT <- SI14IOT %>% 
 dplyr::rename(EU = 'evropska unija', Elec = 'volitve v evropski parlament', EP = 'evropski parlament')
SI19IOT <- SI19IOT %>% 
 dplyr::rename(EU = 'evropska unija', Elec = 'volitve v evropski parlament', EP = 'evropski parlament')

SK14IOT <- SK14IOT %>% 
 dplyr::rename(EU = 'európska únia', Elec = 'voľby do európskeho parlamentu', EP = 'európsky parlament')
SK19IOT <- SK19IOT %>% 
 dplyr::rename(EU = 'európska únia', Elec = 'voľby do európskeho parlamentu', EP = 'európsky parlament')
```

Merge IOT-objects into one dataset (GT) with rbind()

```{r}
GT <- 
  rbind(AT14IOT, AT19IOT, CZ14IOT, CZ19IOT, DE14IOT, DE19IOT, DK14IOT, DK19IOT, 
        EE14IOT, EE19IOT, ES14IOT, ES19IOT, FI14IOT, FI19IOT, FR14IOT, FR19IOT, 
        GB14IOT, GB19IOT, HR14IOT, HR19IOT, HU14IOT, HU19IOT, IE14IOT, IE19IOT, 
        IT14IOT, IT19IOT, LU14IOT, LU19IOT, LV14IOT, LV19IOT, NL14IOT, NL19IOT,
        PL14IOT, PL19IOT, PT14IOT, PT19IOT, RO14IOT, RO19IOT, SE14IOT, SE19IOT, 
        SI14IOT, SI19IOT, SK14IOT, SK19IOT)
```


#Preparation of new gtrends dataset

Transform Keyword variables to numeric, which will create NA's

```{r}
GT[, c(6:8)] <- sapply(GT[, c(6:8)], as.numeric) #transforms hits per keyword to numeric
```

Changing any new NA's to 0

```{r}
GT[is.na(GT)] = 0 
```

Two main things happen here:
 - The date variable is changed to date format
 - A dummy variable [0 = 2014, 1 = 2019] is computed  

The dummy is meant for later regression

```{r}
year(date(as.POSIXct("2014-04-25", format = "%Y-%m-%d")))
year(date(as.POSIXct("2019-04-26", format = "%Y-%m-%d")))

GT <- GT %>%
  mutate(year = year(date)) 
  
GT <- 
  dummy_cols(GT, select_columns = "year", remove_first_dummy = TRUE)
```


#Split-apply-combine aggregation of gtrends dataset

Summarization of the keyword data per country and year 

```{r}
GTsum <- GT %>%
 select(geo, year, year_2019, EU, Elec, EP) %>%
  group_by(geo, year_2019) %>%
  dplyr::summarise(
    mean_EU = mean(EU), median_EU = median(EU), variance_EU = var(EU), total_EU = sum(EU),
    mean_EP = mean(EP), median_EP = median(EP), variance_EP = var(EP), total_EP = sum(EP),
    mean_Elec = mean(Elec), median_Elec = median(Elec), variance_Elec = var(Elec), 
    total_Elec = sum(Elec)) %>%
  arrange(geo) %>% 
  as_tibble() 
```

Renaming of values in the new grouped variable - since 'geo' was not renamed earlier - so that each country abbrevation is changed with full country name.
This assures consistency for when the data will be merged with the VoterData (from earlier)

```{r}
GTsum[GTsum$geo == 'AT', "geo"] <- 'Austria'
GTsum[GTsum$geo == 'CZ', "geo"] <- 'Czech Republic'
GTsum[GTsum$geo == 'DE', "geo"] <- 'Germany'
GTsum[GTsum$geo == 'DK', "geo"] <- 'Denmark'
GTsum[GTsum$geo == 'EE', "geo"] <- 'Estonia'
GTsum[GTsum$geo == 'ES', "geo"] <- 'Spain'
GTsum[GTsum$geo == 'FI', "geo"] <- 'Finland'
GTsum[GTsum$geo == 'FR', "geo"] <- 'France'
GTsum[GTsum$geo == 'GB', "geo"] <- 'United Kingdom'
GTsum[GTsum$geo == 'HR', "geo"] <- 'Croatia'
GTsum[GTsum$geo == 'HU', "geo"] <- 'Hungary'
GTsum[GTsum$geo == 'IE', "geo"] <- 'Ireland'
GTsum[GTsum$geo == 'IT', "geo"] <- 'Italy'
GTsum[GTsum$geo == 'LU', "geo"] <- 'Luxembourg'
GTsum[GTsum$geo == 'LV', "geo"] <- 'Latvia'
GTsum[GTsum$geo == 'NL', "geo"] <- 'Netherlands'
GTsum[GTsum$geo == 'PL', "geo"] <- 'Poland'
GTsum[GTsum$geo == 'PT', "geo"] <- 'Portugal'
GTsum[GTsum$geo == 'RO', "geo"] <- 'Romania'
GTsum[GTsum$geo == 'SE', "geo"] <- 'Sweden'
GTsum[GTsum$geo == 'SI', "geo"] <- 'Slovenia'
GTsum[GTsum$geo == 'SK', "geo"] <- 'Slovakia'
```

Change the name of the actual variable from 'geo' to 'Country'
```{r}
GTsum <- GTsum %>% 
  rename(Country = 'geo')
```

#Regression analysis

First of all we have to merge the two datasets 'GTsum' and 'VoterDat1419' 
```{r}
VotesTrends <- 
  inner_join(GTsum, VoterDat1419, by = "Country")

glimpse(VotesTrends)
```


Here we rename Voter Turnout
```{r}
VotesTrends <- VotesTrends %>% 
  dplyr::rename(Voter_Turnout = 'Voter Turnout')
```
A simplified format is cor(x, use=, method= ) where

Option	Description

x ->	Matrix or data frame

use ->	Specifies the handling of missing data. Options are 
       all.obs (assumes no missing data - missing data will produce an error)
       complete.obs (listwise deletion), and 
       pairwise.complete.obs (pairwise deletion)

method ->	Specifies the type of correlation. Options are pearson, spearman or kendall.


REGRESSION

Here I try to run a regression model

y ~ x1 + x2, data = df


MODEL 1
```{r}
m1 <- lm(Voter_Turnout ~ total_EP + total_EU + total_Elec + mean_EP +  mean_EU +  mean_Elec + median_EP + median_EU + median_Elec + variance_EP + variance_EU + variance_Elec + Country + year_2019 , data = VotesTrends)
summary(m1)
```

